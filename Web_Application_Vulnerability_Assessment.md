## Command Injection / Brute Force / XSS Attacks

For this vulnerability assessment I will use a DVWA instance, the "Damn Vulnerable Web Application", bWAPP, the BeEF framework and Burp Suite.

In the first part of this write-up I will cover command injection attacks and demonstrate one.

Command Injections are possible because of a lack of input validation, allowing users to run commands against an operating system. When that happens, a malicious actor can trick the webserver using complex queries to gain access/display data that is not supposed to be accessed via user input.

In the example below, I visited a web page allowing me to ping a device by entering the IP address into a field and clicking the "submit" button to display the result of the ping. Then I crafted a query to gain access and display the content of the "passwd" file. 

To do so I used a technique called the "dot-dot-slash" method to design my payloads. 

When the command is run from the web page Ping input field, I don't really know where I am within the linux webserver. So using the "dot-dot-slash" method, I am able to add "../" after my `cat` command followed by /etc/passwd until I hit the exact position of the file in the webserver operating system. When I finally hit the location of the directory, the content of the "passwd" file is displayed on the webpage.



Command used to display “/etc/passwd”:

```bash
8.8.8.8 && ls; cat ../../../../../etc/passwd
```


#### Result:

![dvwa command injection](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/etc_passwd_command_injection_successful.png)

Breakdown of the command:

`8.8.8.8` is the IP address that I want to Ping. Now to run my command I add `&&` just like I would via the Linux Command Line Interface, and it is used to add the following command. `ls` displays the content of a directory/folder and `cat` displays the content of a file.


Command to display “/etc/hosts”

```bash
8.8.8.8 && ls; cat ../../../../../etc/hosts
```

![dvwa command injection](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/etc_hosts_command_injection_successful.png)

#### Mitigation:

There are several practices that can be implemented to prevent command injections, below a few of them:

- Set up input validation, where arguments with “;”, “&&”, “|” and “..” or “../” are banned.
- Create a white list of possible inputs to make sure that the system will accept only predefined inputs. For example, if an input field requires users to type in a day of the   week, only the 7 days of the week can be accepted as an input for this specific field.
- Use only secure APIs. For example with Java, instead of using Runtime.exec() to issue a mail command, it’s safer to use the available API located at javax.mail. Instead of     running a process that has the power to control many more processes and can be leveraged to run other commands than what it was intended for in the first place, an API will    have a narrower function, and will be called to accomplish a certain task tied to a microservice most of the time.


## Brute Force Attack

In this assessment I will use Burp Suite and more specifically the "Intruder" feature. I will use the bWAPP open source insecure web application.

The goal of this pentest is to show you how in a few steps, with an open source tool and a list of username & password, anybody can launch a successful brute force attack (especially without 2FA enabled) to gain access to a web application portal. 

### Intercepting Web Requests in Burp Suite 

We will use Burp Suite to intercept a login web request, analyze the request and design a payload that will be launched by Burp Suite to brute force access to the web portal.

Below is how I did it.

First, I installed the Foxy Proxy web browser extension (you can easily find online guides to download and learn how to use the extension). This extension allows me to set up a proxy via Burp Suite so that all web requests are intercepted in Burp Suite before being actually sent to the server.

Next I launched the bWAPP locally on my lab machine and opened the insecure login web page (192.168.13.35/ba_insecure_login_1.php). This page is an admin web application login page. When you use the correct credentials to login, it will return a "Successful" message and if the credentials are incorrect it will return "Invalid credentials".


For this demonstration, I will use an existing list of usernames & passwords to show you how we can use Burp Suite to automatically brute force access to the web application.

I begin by turning on Foxy Proxy and entering wrong credentials so that I can send a request and have it intercepted in Burp Suite for analysis:

![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/login_capture_web_request_w_burpsuite.png)


Next, I analyzed the request in the “Intercept” section of Burp Suite:


![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/burpsuite_intercept.png)


Next, I set up the payload by selecting the Username (login) and password fields by highlighting the placeholders that the “Intruder” module will use to brute force the access:


![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/burpsuite_settingUP_payload.png)


Next, I set up the 2 payload sets. "Set 1" is the Username list we will use in the “Login” section of the page. "Set 2" is the password list that will be used in the “password” section of the web page:


![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/payload_set_1.png)


![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/payload_set_2.png)


A few minutes later, I was able to identify the vulnerable account. 99/100 requests were unsuccessful, but one was a success and I was able to login. 

By looking at the HTTP response I was able to quickly check if I was successful or not, indeed, all failed requests have an HTTP response length of “11801” but one request was slightly longer at “11827”, representing the successful one: Login: `tonystark` | Password: `I am Iron Man`


Below, I highlighted a failed request to login. As you can see the payload 1 is the username and the payload 2 is the password that was automatically used by the Intruder module of Burp Suite to perform the brute force attack. In the bottom part of the screenshot you can see a render of the web page with the result of the request and, as we can see, the credentials did not work and "invalid credentials!" was displayed. 


![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/bWAPP_unsuccessful_exploit.png)


Now, when paying close attention to the length of the response, i.e., 11801, I noticed that all failed requests have the same length (see above screenshot).

Next, scrolling through the failed attempts at login, I noticed one response with a slightly longer length, i.e., 11827. I then clicked on the render tab and noticed that the credentials used by Burp Suite worked and the username/password combo that allowed me access to the web application was `tonystark` / `I am Iron Man` (screenshot below):

![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/bWAPP_successful_exploit.png)


#### Mitigation:

There are a few best practices and technical control that we can set up:

- Requiring long, passphrase-type passwords that will render close to impossible to brute force.
- Requiring the use of 2FA (Two Factor Authentication or Multi-Factor Authentication).
- Setting up an automatic lockout after a certain number of failed attempts have been made against an account.


## XSS Attack

To demonstrate how an XSS or Cross Site Scripting attack is performed and exploited, I will use the Browser Exploitation Framework AKA BeEF. It's a client-side attack tool that exploits vulnerabilities of web browsers to assess the security posture of a target.

This tool is used by pentester/security researcher and unfortunately by malicious actors as well.

How does it work?

First, an attacker will craft or use an existing snippet of code, in the case of BeEF, it is called a BeEF hook. However, the challenge for a malicious actor is to find a way to add this malicious code to the target website. And most of the time it is done using cross site scripting.

When a website is successfully compromised, i.e., when the malicious snippet of code is added to the target website, it becomes "hooked".

Now, once the browser is hooked, BeEF can be used to launch different types of attacks. In this section, I am going to use an instance of the DVWA web application, then I will inject a malicious XSS snippet of code to infect the website and finish by launching a few attacks using the BeEF framework.

In the below screenshot, I used a javascript payload that I injected into the XSS web page of the DVWA web application, I simply copy pasted it into the "Message" section and submitted it. I will go into more details as to how to craft XSS payloads in the future.


![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/url_shortened_exploit_script.png)


Submitting the form enabled the hook and the exploit was successful as seen on the screenshots below:


![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/beEF_exploit_confirmed_1.png)

![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/beEF_exploit_confirmed_2.png)


Following the confirmation that the exploit worked and that the target’s web browser was now hooked to beEF, I ran a few exploits:


### Exploit 1 - Pretty Theft

Pretty Theft is one of the exploits that the BeEF framework offers. It's a Social Engineering type of exploit that will produce a pop-up window on the victim's screen asking them for their email and password. The BeEF framework gives me a couple options to choose from, I have the option to simulate a Facebook Session Time Out window or a Google one as well as other popular websites login windows. 

For this demonstration, I picked the Facebook one and ran the exploit:

![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/Exploit_Pretty_Theft_Facebook_start.png)

Below, the fake Facebook Session Timed Out windows asking the victim for their credentials. In a real situation, the attacker would track the victim's web browsing activity after compromising their web browser and would match the pop-up window theme to the website the victim is visiting. For the sake of the demonstration, I am only covering the behind the scene hacking that is taking place.

![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/Exploit_Pretty_Theft_Facebook_popup.png)


Next, to test the exploit, I entered the username "Ward" (instead of an email, but the victim's would enter an email) and the password "superpassword". In the below screenshot, we can see that the credentials I entered in the malicious pop-up window have been directly sent to the malicious actor's BeEF control panel.

Hacked credentials:

![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/Exploit_Pretty_Theft_Facebook_hacked_.png)


Generic version of the pop-up window, in the BeEF style:

![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/Exploit_Pretty_Theft_Facebook_generic_pop.png)

And hacked credentials:


![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/Exploit_Pretty_Theft_Facebook_generic_pop_hacked.png)


### Exploit 2 - Fake Notification Bar

This time I wanted to have a fake notification bar pop-up at the top of the victim's web page prompting the victim to install required plug-ins in order to display some elements on the page. It's a classic pop-up window and one of the most effective ones in the BeEF arsenal. I selected the Fake Notification Bar module in the Social Engineering section for Firefox since I know that my victim's web browser is Firefox:

Below, the exploit in action:

![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/Exploit_Fake_Notification_bar_firefox.png)

I then clicked on the "Install plug-ins" button. Next, I checked my BeEF control panel and I can see that I got confirmation that my notification bar was successfully displayed and that the victim (played by me) has clicked the notification. It's a success.

Below, the exploit in action:


![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/Exploit_Fake_Notification_bar_firefox_fake_bar.png)


![bWAPP brute force](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/Exploit_Fake_Notification_bar_firefox_fake_bar_hacked.png)


### Example of Mitigations:

- We can add a server-side input validation to deny malicious scripts as input. Since it all started with a malicious script command injection into the “Message” box, a        server-side on top of the client-side input validation could have stopped this attack from the start.
- Use HTTP response headers that can prevent such malicious scripts from running.










